<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viphery ¬∑ Alta de Incidencia</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00f5d4',
            darkbg: '#0b0f19',
            cardbg: '#121826'
          },
          boxShadow: {
            neon: '0 0 0 1px rgba(0,245,212,0.25), 0 0 28px rgba(0,245,212,0.08)'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-darkbg text-gray-200 min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-3xl bg-cardbg rounded-2xl shadow-xl p-8 space-y-8">

    <!-- HEADER -->
    <div class="border-b border-gray-700 pb-4">
      <h1 class="text-2xl font-bold text-primary">Viphery</h1>
      <p class="text-sm text-gray-400">Alta de Incidencia</p>
    </div>

    <!-- FORM -->
    <form id="incidenciaForm" class="space-y-6" enctype="multipart/form-data">
      <!-- Hidden: list_id -->
      <input type="hidden" name="list_id" id="list_id" value="" />

      <!-- PROYECTO (rollup) -->
      <div class="relative">
        <label class="block text-sm mb-1">Proyecto (lista de ClickUp)</label>
        <input
          type="text"
          id="projectSearch"
          name="projectSearch"
          autocomplete="off"
          required
          placeholder="Empieza a escribir para buscar proyectos..."
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        />

        <!-- dropdown -->
        <div
          id="projectDropdown"
          class="hidden absolute z-20 mt-2 w-full rounded-xl border border-gray-700 bg-black/60 backdrop-blur shadow-neon overflow-hidden"
        >
          <div id="projectResults" class="max-h-64 overflow-auto"></div>
          <div id="projectEmpty" class="hidden px-4 py-3 text-sm text-gray-400">
            No se encontraron proyectos.
          </div>
        </div>

        <p id="projectHint" class="mt-2 text-xs text-gray-500">
          Selecciona un proyecto del desplegable. (Esto define d√≥nde se crea la incidencia)
        </p>
      </div>

      <!-- EXTRACTO -->
      <div>
        <label class="block text-sm mb-1">Extracto de la incidencia</label>
        <input
          type="text"
          name="taskName"
          id="taskName"
          required
          placeholder="Ej. Puertas da√±adas en montaje"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        />
      </div>

      <!-- DESCRIPCI√ìN -->
      <div>
        <label class="block text-sm mb-1">Descripci√≥n detallada</label>
        <textarea
          name="description"
          id="description"
          rows="6"
          placeholder="Describe la incidencia con el m√°ximo detalle posible‚Ä¶"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
      </div>

      <!-- PRIORIDAD -->
      <div>
        <label class="block text-sm mb-1">Prioridad</label>
        <select
          name="priority"
          id="priority"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        >
          <option value="4">Baja</option>
          <option value="3" selected>Normal</option>
          <option value="2">Alta</option>
          <option value="1">Urgente</option>
        </select>
      </div>

      <!-- ADJUNTOS -->
      <div>
        <label class="block text-sm mb-2">Adjuntar archivos</label>

        <label
          for="files"
          class="flex items-center justify-center w-full px-4 py-6 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer hover:border-primary hover:shadow-neon transition"
        >
          <span class="text-sm text-gray-400">
            Haz clic o arrastra archivos aqu√≠
          </span>
        </label>

        <!-- IMPORTANTE: name="file" para que n8n lo reciba como binary.file -->
        <input
          id="files"
          type="file"
          name="file"
          multiple
          class="hidden"
        />

        <!-- LISTADO DE ARCHIVOS -->
        <ul id="fileList" class="mt-4 space-y-2 text-sm text-gray-300"></ul>
      </div>

      <!-- BOT√ìN -->
      <div class="pt-2">
        <button
          id="submitBtn"
          type="submit"
          class="w-full bg-primary text-black font-semibold py-3 rounded-xl hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Enviar incidencia
        </button>

        <p id="statusMsg" class="mt-3 text-sm text-gray-400 hidden"></p>
      </div>
    </form>
  </div>

  <script>
    // Webhooks (ya insertados)
    const SEARCH_PROJECTS_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-buscar-proyectos';
    const CREATE_INCIDENCE_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-crear-incidencia';

    // --- Adjuntos: mostrar archivos seleccionados ---
    const fileInput = document.getElementById('files');
    const fileList = document.getElementById('fileList');

    fileInput.addEventListener('change', () => {
      fileList.innerHTML = '';
      Array.from(fileInput.files).forEach(file => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-darkbg border border-gray-700 rounded-lg px-3 py-2';
        li.innerHTML = `
          <span class="truncate max-w-[70%]">üìé ${escapeHtml(file.name)}</span>
          <span class="text-xs text-gray-400">${(file.size / 1024).toFixed(1)} KB</span>
        `;
        fileList.appendChild(li);
      });
    });

    // --- Proyecto: autocomplete / rollup ---
    const projectSearch = document.getElementById('projectSearch');
    const listIdInput = document.getElementById('list_id');
    const dropdown = document.getElementById('projectDropdown');
    const results = document.getElementById('projectResults');
    const empty = document.getElementById('projectEmpty');

    let debounceTimer = null;
    let lastQuery = '';

    projectSearch.addEventListener('input', () => {
      // Si el usuario edita, invalidamos el list_id hasta que seleccione de nuevo
      listIdInput.value = '';
      scheduleSearch(projectSearch.value);
    });

    projectSearch.addEventListener('focus', () => {
      if (projectSearch.value.trim().length >= 1) {
        scheduleSearch(projectSearch.value, true);
      }
    });

    document.addEventListener('click', (e) => {
      const isInside = dropdown.contains(e.target) || projectSearch.contains(e.target);
      if (!isInside) hideDropdown();
    });

    function scheduleSearch(q, immediate = false) {
      const query = (q || '').trim();
      if (!query) {
        hideDropdown();
        return;
      }

      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => searchProjects(query), immediate ? 0 : 250);
    }

    async function searchProjects(query) {
      if (query === lastQuery) return;
      lastQuery = query;

      showDropdown();
      results.innerHTML = `<div class="px-4 py-3 text-sm text-gray-400">Buscando...</div>`;
      empty.classList.add('hidden');

      try {
        const res = await fetch(SEARCH_PROJECTS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!res.ok) throw new Error('Error consultando proyectos');
        const data = await res.json();

        renderProjects(Array.isArray(data) ? data : []);
      } catch (err) {
        results.innerHTML = `<div class="px-4 py-3 text-sm text-red-400">Error consultando proyectos</div>`;
      }
    }

    function renderProjects(list) {
      results.innerHTML = '';
      if (!list.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      list.forEach(item => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left px-4 py-3 hover:bg-primary/10 border-b border-gray-800 last:border-b-0';
        btn.innerHTML = `
          <div class="text-sm text-gray-100">${escapeHtml(item.name)}</div>
          <div class="text-xs text-gray-500">ID: ${escapeHtml(String(item.id))}</div>
        `;
        btn.addEventListener('click', () => {
          projectSearch.value = item.name;
          listIdInput.value = item.id;     // <-- CLAVE: list_id real
          hideDropdown();
        });
        results.appendChild(btn);
      });
    }

    function showDropdown() {
      dropdown.classList.remove('hidden');
    }

    function hideDropdown() {
      dropdown.classList.add('hidden');
    }

    // --- Submit formulario ---
    const form = document.getElementById('incidenciaForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusMsg = document.getElementById('statusMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validaci√≥n m√≠nima: obligar a que list_id est√© seleccionado
      if (!listIdInput.value) {
        showStatus('Selecciona un proyecto del desplegable (no vale texto libre).', true);
        projectSearch.focus();
        return;
      }

      submitBtn.disabled = true;
      showStatus('Enviando incidencia...', false);

      try {
        const formData = new FormData(form);

        // Mapeo a lo que sueles usar en n8n (por si tu workflow lo espera as√≠)
        // - list_id: ya existe
        // - taskName / description / priority: ya existen
        // Si tu workflow espera extracto/detalle, puedes leer taskName/description en n8n.
        // (Evito duplicar para no romper binarios.)

        const res = await fetch(CREATE_INCIDENCE_URL, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error('Error al enviar');
        // opcional: const json = await res.json();

        showStatus('‚úÖ Incidencia enviada correctamente.', false);
        form.reset();
        fileList.innerHTML = '';
        listIdInput.value = '';
        lastQuery = '';
        hideDropdown();
      } catch (err) {
        showStatus('‚ùå Error al enviar la incidencia. Revisa n8n (Executions).', true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    function showStatus(msg, isError) {
      statusMsg.textContent = msg;
      statusMsg.classList.remove('hidden');
      statusMsg.classList.toggle('text-red-400', !!isError);
      statusMsg.classList.toggle('text-gray-400', !isError);
    }

    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }
  </script>
</body>
</html>
