<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registrar incidencia</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Tailwind config -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#eff6ff',
              500: '#2563eb',
              600: '#1d4ed8'
            }
          }
        }
      }
    }
  </script>

  <!-- Font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="min-h-screen bg-gradient-to-br from-slate-100 via-slate-200 to-slate-300 flex items-center justify-center p-6">

  <div class="w-full max-w-3xl">
    <div class="bg-white/90 backdrop-blur rounded-2xl shadow-2xl p-10">

      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-2xl font-semibold text-slate-900">Registrar incidencia</h1>
        <p class="text-slate-500 mt-1 text-sm">
          Selecciona el proyecto y describe claramente la incidencia.
        </p>
      </div>

      <form id="incidenceForm" class="space-y-6">

        <!-- Proyecto -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            Proyecto
          </label>
          <select
            id="projectSelect"
            name="list_id"
            required
            class="w-full rounded-xl border-slate-300 focus:border-brand-500 focus:ring-brand-500"
          >
            <option>Cargando proyectos…</option>
          </select>
        </div>

        <!-- Extracto -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            Extracto de la incidencia
          </label>
          <input
            type="text"
            name="extracto"
            required
            placeholder="Ej: Encimera dañada en esquina izquierda"
            class="w-full rounded-xl border-slate-300 px-4 py-3 text-lg font-medium focus:border-brand-500 focus:ring-brand-500"
          >
        </div>

        <!-- Detalle -->
        <div>
          <label class="block text-sm font-medium text-slate-700 mb-1">
            Detalle de la incidencia
          </label>
          <textarea
            name="detalle"
            rows="5"
            placeholder="Describe aquí la incidencia con todo el contexto necesario…"
            class="w-full rounded-xl border-slate-300 px-4 py-3 focus:border-brand-500 focus:ring-brand-500"
          ></textarea>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

          <!-- Prioridad -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Prioridad
            </label>
            <select
              name="priority"
              class="w-full rounded-xl border-slate-300 focus:border-brand-500 focus:ring-brand-500"
            >
              <option value="">Normal</option>
              <option value="1">Urgente</option>
              <option value="2">Alta</option>
              <option value="3">Media</option>
              <option value="4">Baja</option>
            </select>
          </div>

          <!-- Adjuntos -->
          <div>
            <label class="block text-sm font-medium text-slate-700 mb-1">
              Adjuntos
            </label>
            <label class="flex flex-col items-center justify-center gap-2 px-4 py-6 border-2 border-dashed border-slate-300 rounded-xl cursor-pointer hover:border-brand-500 transition">
              <span class="text-slate-500 text-sm">
                Arrastra archivos o haz clic
              </span>
              <input
                type="file"
                name="attachments"
                multiple
                class="hidden"
              >
            </label>
          </div>

        </div>

        <!-- Actions -->
        <div class="pt-6 flex justify-end">
          <button
            type="submit"
            class="inline-flex items-center gap-2 bg-brand-500 hover:bg-brand-600 text-white font-semibold px-8 py-3 rounded-xl shadow-lg transition disabled:opacity-50"
          >
            Enviar incidencia
          </button>
        </div>

        <!-- Status -->
        <div id="status" class="text-sm hidden"></div>

      </form>
    </div>
  </div>

<script>
  const SEARCH_PROJECTS_URL = 'https://TU_N8N/webhook/buscar-proyectos';
  const CREATE_INCIDENCE_URL = 'https://TU_N8N/webhook/crear-incidencia';

  const projectSelect = document.getElementById('projectSelect');
  const form = document.getElementById('incidenceForm');
  const statusEl = document.getElementById('status');
  const submitBtn = form.querySelector('button');

  fetch(SEARCH_PROJECTS_URL)
    .then(res => res.json())
    .then(data => {
      projectSelect.innerHTML = '<option value="">Selecciona un proyecto</option>';
      data.forEach(item => {
        const opt = document.createElement('option');
        opt.value = item.json?.id || item.id;
        opt.textContent = item.json?.name || item.name;
        projectSelect.appendChild(opt);
      });
    })
    .catch(() => {
      projectSelect.innerHTML = '<option>Error cargando proyectos</option>';
    });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    submitBtn.disabled = true;
    statusEl.className = 'text-sm text-slate-500';
    statusEl.textContent = 'Enviando incidencia…';
    statusEl.classList.remove('hidden');

    const formData = new FormData(form);

    try {
      const res = await fetch(CREATE_INCIDENCE_URL, {
        method: 'POST',
        body: formData
      });

      if (!res.ok) throw new Error();

      statusEl.className = 'text-sm text-green-600';
      statusEl.textContent = 'Incidencia registrada correctamente.';
      form.reset();

    } catch {
      statusEl.className = 'text-sm text-red-600';
      statusEl.textContent = 'Error al registrar la incidencia.';
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>

</body>
</html>
