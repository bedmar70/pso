<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>VIPHERY · Registrar Incidencia</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            neon: '#22d3ee',
            bgdark: '#0b1220',
            bgpanel: '#0f172a'
          },
          boxShadow: {
            neon: '0 0 0 1px rgba(34,211,238,.3), 0 0 25px rgba(34,211,238,.15)'
          }
        }
      }
    }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="min-h-screen bg-gradient-to-br from-bgdark via-black to-bgdark text-slate-200">

<div class="max-w-4xl mx-auto px-6 py-10">

  <!-- Header -->
  <div class="flex justify-between items-center mb-10">
    <div>
      <h1 class="text-2xl font-semibold tracking-wide text-cyan-400">
        VIPHERY SYSTEM
      </h1>
      <p class="text-xs text-slate-400 tracking-widest mt-1">
        REGISTRO DE INCIDENCIAS
      </p>
    </div>
  </div>

  <!-- Panel -->
  <div class="bg-bgpanel/80 backdrop-blur rounded-2xl shadow-xl border border-cyan-500/20 p-8">

    <form id="incidenceForm" class="space-y-8">

      <!-- Proyecto autocomplete -->
      <div class="relative">
        <label class="block text-xs uppercase tracking-widest text-cyan-400 mb-2">
          Proyecto
        </label>
        <input
          type="text"
          id="projectInput"
          placeholder="Empieza a escribir para buscar…"
          class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-3 focus:border-cyan-400 focus:ring-0 outline-none"
        >
        <input type="hidden" name="list_id" id="projectId">

        <div
          id="projectResults"
          class="absolute z-10 mt-2 w-full bg-black border border-slate-700 rounded-xl overflow-hidden hidden"
        ></div>
      </div>

      <!-- Extracto -->
      <div>
        <label class="block text-xs uppercase tracking-widest text-cyan-400 mb-2">
          Extracto de la incidencia
        </label>
        <input
          type="text"
          name="extracto"
          required
          class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-3 text-lg focus:border-cyan-400 outline-none"
        >
      </div>

      <!-- Detalle -->
      <div>
        <label class="block text-xs uppercase tracking-widest text-cyan-400 mb-2">
          Detalle de la incidencia
        </label>
        <textarea
          name="detalle"
          rows="5"
          class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-3 focus:border-cyan-400 outline-none"
        ></textarea>
      </div>

      <!-- Prioridad + Adjuntos -->
      <div class="grid md:grid-cols-2 gap-6">

        <div>
          <label class="block text-xs uppercase tracking-widest text-cyan-400 mb-2">
            Prioridad
          </label>
          <select
            name="priority"
            class="w-full bg-black/40 border border-slate-700 rounded-xl px-4 py-3 focus:border-cyan-400"
          >
            <option value="">Normal</option>
            <option value="1">Urgente</option>
            <option value="2">Alta</option>
            <option value="3">Media</option>
            <option value="4">Baja</option>
          </select>
        </div>

        <div>
          <label class="block text-xs uppercase tracking-widest text-cyan-400 mb-2">
            Adjuntos
          </label>
          <label class="flex flex-col items-center justify-center h-24 border border-dashed border-slate-600 rounded-xl cursor-pointer hover:border-cyan-400 hover:shadow-neon transition">
            <span class="text-sm text-slate-400">
              Click o arrastra archivos
            </span>
            <input type="file" name="attachments" multiple class="hidden">
          </label>
        </div>

      </div>

      <!-- Actions -->
      <div class="flex justify-end pt-6">
        <button
          type="submit"
          class="bg-cyan-500 hover:bg-cyan-400 text-black font-semibold px-8 py-3 rounded-xl shadow-lg transition"
        >
          Registrar incidencia
        </button>
      </div>

      <div id="status" class="text-sm hidden"></div>

    </form>
  </div>
</div>

<script>
  const SEARCH_PROJECTS_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-buscar-proyectos';
  const CREATE_INCIDENCE_URL = 'https://TU_N8N/webhook/crear-incidencia';

  const projectInput = document.getElementById('projectInput');
  const projectResults = document.getElementById('projectResults');
  const projectIdInput = document.getElementById('projectId');
  const form = document.getElementById('incidenceForm');
  const statusEl = document.getElementById('status');

  let debounce;

  projectInput.addEventListener('input', () => {
    clearTimeout(debounce);
    const query = projectInput.value.trim();
    if (!query) {
      projectResults.classList.add('hidden');
      return;
    }

    debounce = setTimeout(async () => {
      const res = await fetch(SEARCH_PROJECTS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query })
      });

      const data = await res.json();
      projectResults.innerHTML = '';
      projectResults.classList.remove('hidden');

      data.forEach(item => {
        const div = document.createElement('div');
        div.textContent = item.json?.name || item.name;
        div.className = 'px-4 py-2 hover:bg-cyan-500/20 cursor-pointer';
        div.onclick = () => {
          projectInput.value = div.textContent;
          projectIdInput.value = item.json?.id || item.id;
          projectResults.classList.add('hidden');
        };
        projectResults.appendChild(div);
      });
    }, 300);
  });

  form.addEventListener('submit', async e => {
    e.preventDefault();

    statusEl.textContent = 'Enviando incidencia…';
    statusEl.className = 'text-sm text-cyan-400';
    statusEl.classList.remove('hidden');

    const formData = new FormData(form);

    try {
      const res = await fetch(CREATE_INCIDENCE_URL, {
        method: 'POST',
        body: formData
      });

      if (!res.ok) throw new Error();

      statusEl.textContent = 'Incidencia registrada correctamente.';
      statusEl.className = 'text-sm text-green-400';
      form.reset();

    } catch {
      statusEl.textContent = 'Error al registrar la incidencia.';
      statusEl.className = 'text-sm text-red-400';
    }
  });
</script>

</body>
</html>



