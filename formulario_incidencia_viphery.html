<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Crear Incidencia – Viphery</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background: radial-gradient(circle at top, #0f172a, #020617);
    }
  </style>
</head>

<body class="min-h-screen flex items-center justify-center text-slate-200">

  <div class="w-full max-w-3xl bg-slate-900/80 backdrop-blur rounded-xl shadow-2xl p-8">
    <h1 class="text-2xl font-bold text-cyan-400 mb-6">
      Crear Incidencia
    </h1>

    <form id="incidenciaForm" class="space-y-6">

      <!-- Nombre incidencia -->
      <div>
        <label class="block text-sm mb-1">Extracto de la incidencia</label>
        <input
          type="text"
          name="taskName"
          required
          class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 focus:ring focus:ring-cyan-500"
        />
      </div>

      <!-- Descripción -->
      <div>
        <label class="block text-sm mb-1">Descripción detallada</label>
        <textarea
          name="description"
          rows="4"
          class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 focus:ring focus:ring-cyan-500"
        ></textarea>
      </div>

      <!-- Prioridad -->
      <div>
        <label class="block text-sm mb-1">Prioridad</label>
        <select
          name="priority"
          class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
        >
          <option value="1">Alta</option>
          <option value="2" selected>Normal</option>
          <option value="3">Baja</option>
        </select>
      </div>

      <!-- Lista / Proyecto -->
      <div>
        <label class="block text-sm mb-1">Proyecto</label>
        <input
          type="text"
          name="list_id"
          placeholder="ID de lista (rollup)"
          class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2"
        />
      </div>

      <!-- Adjuntos -->
      <div>
        <label class="block text-sm mb-2">Adjuntar archivos</label>

        <input
          type="file"
          id="fileInput"
          multiple
          class="block w-full text-sm text-slate-300
                 file:mr-4 file:py-2 file:px-4
                 file:rounded file:border-0
                 file:bg-cyan-600 file:text-white
                 hover:file:bg-cyan-500"
        />

        <ul id="fileList" class="mt-3 space-y-2"></ul>
      </div>

      <!-- Botón -->
      <button
        type="submit"
        class="w-full bg-cyan-600 hover:bg-cyan-500 text-white py-3 rounded font-semibold"
      >
        Enviar incidencia
      </button>

      <!-- Mensaje -->
      <div id="statusMessage" class="text-center text-sm mt-4"></div>

    </form>
  </div>

<script>
  const form = document.getElementById('incidenciaForm');
  const fileInput = document.getElementById('fileInput');
  const fileList = document.getElementById('fileList');
  const statusMessage = document.getElementById('statusMessage');

  let filesBuffer = [];

  // Render adjuntos
  function renderFileList() {
    fileList.innerHTML = '';
    filesBuffer.forEach((file, index) => {
      const li = document.createElement('li');
      li.className = 'flex justify-between items-center bg-slate-800 px-3 py-2 rounded';

      li.innerHTML = `
        <span class="text-sm truncate">${file.name}</span>
        <button type="button" class="text-red-400 hover:text-red-300 text-sm">❌</button>
      `;

      li.querySelector('button').onclick = () => {
        filesBuffer.splice(index, 1);
        renderFileList();
      };

      fileList.appendChild(li);
    });
  }

  fileInput.addEventListener('change', () => {
    for (const file of fileInput.files) {
      filesBuffer.push(file);
    }
    fileInput.value = '';
    renderFileList();
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    statusMessage.textContent = 'Enviando incidencia...';
    statusMessage.className = 'text-cyan-400';

    const formData = new FormData(form);

    filesBuffer.forEach(file => {
      formData.append('file', file);
    });

    try {
      const response = await fetch(
        'https://n8n.escueladeefectividad.com/webhook/viphery-crear-incidencia',
        {
          method: 'POST',
          body: formData
        }
      );

      if (!response.ok) throw new Error('Error en el envío');

      statusMessage.textContent = '✅ Incidencia enviada correctamente';
      statusMessage.className = 'text-green-400';

      // RESET COMPLETO
      setTimeout(() => {
        form.reset();
        filesBuffer = [];
        renderFileList();
        statusMessage.textContent = '';
      }, 2500);

    } catch (err) {
      statusMessage.textContent = '❌ Error al enviar la incidencia';
      statusMessage.className = 'text-red-400';
    }
  });
</script>

</body>
</html>
