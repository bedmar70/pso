<script>
  // ================== WEBHOOKS ==================
  const SEARCH_PROJECTS_URL =
    'https://n8n.escueladeefectividad.com/webhook/viphery-buscar-proyectos';
  const CREATE_INCIDENCE_URL =
    'https://n8n.escueladeefectividad.com/webhook/viphery-crear-incidencia';

  // ================== ELEMENTOS ==================
  const form = document.getElementById('incidenciaForm');
  const submitBtn = document.getElementById('submitBtn');
  const statusMsg = document.getElementById('statusMsg');

  const projectSearch = document.getElementById('projectSearch');
  const listIdInput = document.getElementById('list_id');
  const dropdown = document.getElementById('projectDropdown');
  const results = document.getElementById('projectResults');
  const empty = document.getElementById('projectEmpty');

  const fileInput = document.getElementById('files');
  const fileList = document.getElementById('fileList');

  // ================== UTIL ==================
  function escapeHtml(str) {
    return String(str)
      .replaceAll('&', '&amp;')
      .replaceAll('<', '&lt;')
      .replaceAll('>', '&gt;')
      .replaceAll('"', '&quot;')
      .replaceAll("'", '&#039;');
  }

  // ================== ADJUNTOS ==================
  let filesBuffer = [];

  fileInput.addEventListener('change', () => {
    for (const f of fileInput.files) filesBuffer.push(f);
    fileInput.value = '';
    renderFiles();
  });

  function renderFiles() {
    fileList.innerHTML = '';
    filesBuffer.forEach((file, i) => {
      const li = document.createElement('li');
      li.className =
        'flex justify-between items-center bg-darkbg border border-gray-700 rounded px-3 py-2';
      li.innerHTML = `
        <span class="truncate">üìé ${escapeHtml(file.name)}</span>
        <button type="button" class="text-red-400">‚úï</button>
      `;
      li.querySelector('button').onclick = () => {
        filesBuffer.splice(i, 1);
        renderFiles();
      };
      fileList.appendChild(li);
    });
  }

  // ================== ROLLUP PROYECTOS ==================
  let debounceTimer = null;
  let lastQuery = '';

  projectSearch.addEventListener('input', () => {
    listIdInput.value = '';
    scheduleSearch(projectSearch.value);
  });

  projectSearch.addEventListener('focus', () => {
    if (projectSearch.value.trim().length >= 1) {
      scheduleSearch(projectSearch.value, true);
    }
  });

  document.addEventListener('click', (e) => {
    const inside =
      dropdown.contains(e.target) || projectSearch.contains(e.target);
    if (!inside) hideDropdown();
  });

  function scheduleSearch(q, immediate = false) {
    const query = (q || '').trim();
    if (!query) {
      hideDropdown();
      return;
    }
    if (debounceTimer) clearTimeout(debounceTimer);
    debounceTimer = setTimeout(
      () => searchProjects(query),
      immediate ? 0 : 250
    );
  }

  async function searchProjects(query) {
    if (query === lastQuery) return;
    lastQuery = query;

    showDropdown();
    results.innerHTML =
      '<div class="px-4 py-3 text-sm text-gray-400">Buscando...</div>';
    empty.classList.add('hidden');

    try {
      const res = await fetch(SEARCH_PROJECTS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query }),
      });

      if (!res.ok) throw new Error();
      const data = await res.json();
      renderProjects(Array.isArray(data) ? data : []);
    } catch {
      results.innerHTML =
        '<div class="px-4 py-3 text-sm text-red-400">Error consultando proyectos</div>';
    }
  }

  function renderProjects(list) {
    results.innerHTML = '';
    if (!list.length) {
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    list.forEach((item) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className =
        'w-full text-left px-4 py-3 hover:bg-primary/10 border-b border-gray-800 last:border-b-0';
      btn.innerHTML = `
        <div class="text-sm text-gray-100">${escapeHtml(item.name)}</div>
        <div class="text-xs text-gray-500">ID: ${escapeHtml(item.id)}</div>
      `;
      btn.onclick = () => {
        projectSearch.value = item.name;
        listIdInput.value = item.id;
        hideDropdown();
      };
      results.appendChild(btn);
    });
  }

  function showDropdown() {
    dropdown.classList.remove('hidden');
  }

  function hideDropdown() {
    dropdown.classList.add('hidden');
  }

  // ================== SUBMIT ==================
  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    if (!listIdInput.value) {
      statusMsg.textContent =
        'Selecciona un proyecto del desplegable.';
      statusMsg.className = 'mt-3 text-sm text-red-400';
      projectSearch.focus();
      return;
    }

    submitBtn.disabled = true;
    statusMsg.textContent = 'Enviando incidencia...';
    statusMsg.className = 'mt-3 text-sm text-gray-400';

    const fd = new FormData(form);
    filesBuffer.forEach((f) => fd.append('file', f));

    try {
      const res = await fetch(CREATE_INCIDENCE_URL, {
        method: 'POST',
        body: fd,
      });
      if (!res.ok) throw new Error();

      statusMsg.textContent = '‚úÖ Incidencia enviada correctamente';
      statusMsg.className = 'mt-3 text-sm text-green-400';

      setTimeout(() => {
        form.reset();
        filesBuffer = [];
        renderFiles();
        listIdInput.value = '';
        lastQuery = '';
        hideDropdown();
        statusMsg.textContent = '';
      }, 2500);
    } catch {
      statusMsg.textContent = '‚ùå Error al enviar la incidencia';
      statusMsg.className = 'mt-3 text-sm text-red-400';
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
