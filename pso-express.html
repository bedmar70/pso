<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS Portal - Acceso Clientes</title>
    
    <!-- Carga de Librerías desde CDN (No requiere instalación) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Configuración visual -->
    <style>
        body { background-color: #0B0F19; color: #e2e8f0; font-family: sans-serif; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Scrollbar personalizada */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0B0F19; }
        ::-webkit-scrollbar-thumb { background: #2D3748; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #4A5568; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // Acceso global a React
        const { useState, useEffect } = React;

        // --- CONFIGURACIÓN ---
        const N8N_BASE_URL = "https://n8n.escueladeefectividad.com/webhook";
        const ENDPOINTS = {
            AUTH: `${N8N_BASE_URL}/saas-login-master`, 
            OPERATIONS: `${N8N_BASE_URL}/saas-operations-router` 
        };

        // --- ICONOS (Definidos manualmente para evitar fallos de carga externa) ---
        const Icons = {
            Loader2: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            LogOut: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></svg>,
            CheckCircle2: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
            AlertCircle: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>,
            Save: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
            RefreshCw: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 21H3v-5"/></svg>,
            Search: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
        };

        // --- COMPONENTES UI GENÉRICOS ---
        const Button = ({ children, onClick, variant = 'primary', className = '', disabled = false, loading = false }) => {
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-700 shadow-md",
                success: "bg-emerald-600 text-white hover:bg-emerald-700 shadow-md",
                secondary: "bg-slate-800 text-slate-300 border border-slate-700 hover:bg-slate-700",
                ghost: "text-slate-400 hover:text-white hover:bg-white/5"
            };
            return (
                <button 
                    onClick={onClick} 
                    disabled={disabled || loading}
                    className={`px-4 py-2 rounded-lg font-medium transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className}`}
                >
                    {loading && <Icons.Loader2 className="w-4 h-4 animate-spin" />}
                    {children}
                </button>
            );
        };

        // --- PANTALLA DE LOGIN ---
        const LoginScreen = ({ onLogin }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [formData, setFormData] = useState({ email: '', password: '' });

            const handleSubmit = async (e) => {
                e.preventDefault();
                setLoading(true);
                setError('');

                try {
                    // Timestamp para evitar caché
                    const response = await fetch(`${ENDPOINTS.AUTH}?t=${Date.now()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });

                    const text = await response.text();
                    let data = {};
                    try {
                        data = text ? JSON.parse(text) : {};
                    } catch (e) {
                        console.error("Error parseando respuesta Login:", text);
                        throw new Error("Respuesta inválida del servidor");
                    }
                    
                    // Manejo robusto de respuesta (array u objeto)
                    const result = Array.isArray(data) ? data[0] : data;
                    const payload = result.json || result;

                    if (payload && payload.success) {
                        onLogin(payload.tenant);
                    } else {
                        setError(payload?.message || 'Credenciales incorrectas');
                    }
                } catch (err) {
                    console.error(err);
                    setError('Error de conexión. Verifica que el Webhook de N8N esté activo.');
                } finally {
                    setLoading(false);
                }
            };

            return (
                <div className="min-h-screen bg-[#0B0F19] flex items-center justify-center p-4">
                    <div className="max-w-md w-full bg-[#151B2B] rounded-2xl shadow-2xl border border-[#2D3748] overflow-hidden">
                        <div className="p-8 text-center border-b border-[#2D3748]">
                            <div className="w-16 h-16 bg-blue-500/10 rounded-2xl flex items-center justify-center mx-auto mb-4 border border-blue-500/20">
                                <Icons.RefreshCw className="w-8 h-8 text-blue-500" />
                            </div>
                            <h2 className="text-2xl font-bold text-white">SaaS Access</h2>
                            <p className="text-slate-400 text-sm mt-2">Plataforma de Gestión Multi-Cliente</p>
                        </div>
                        <div className="p-8">
                            <form onSubmit={handleSubmit} className="space-y-4">
                                {error && (
                                    <div className="p-3 bg-red-900/20 border border-red-500/30 text-red-400 rounded-lg text-sm flex items-center gap-2">
                                        <Icons.AlertCircle className="w-4 h-4" /> {error}
                                    </div>
                                )}
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Email</label>
                                    <input 
                                        type="email" 
                                        className="w-full bg-[#0B0F19] border border-[#2D3748] rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none transition-colors"
                                        placeholder="usuario@empresa.com" 
                                        value={formData.email} 
                                        onChange={e => setFormData({...formData, email: e.target.value})} 
                                        required 
                                    />
                                </div>
                                <div>
                                    <label className="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Contraseña</label>
                                    <input 
                                        type="password" 
                                        className="w-full bg-[#0B0F19] border border-[#2D3748] rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none transition-colors"
                                        placeholder="••••••••" 
                                        value={formData.password} 
                                        onChange={e => setFormData({...formData, password: e.target.value})} 
                                        required 
                                    />
                                </div>
                                <Button type="submit" variant="primary" className="w-full mt-4" loading={loading}>
                                    Acceder al Panel
                                </Button>
                            </form>
                        </div>
                    </div>
                </div>
            );
        };

        // --- TARJETA DE DECISIÓN INDIVIDUAL ---
        const DecisionCard = ({ task, onUpdate }) => {
            const [observation, setObservation] = useState(task.observaciones || '');
            const [isSaving, setIsSaving] = useState(false);
            const [status, setStatus] = useState(task.status?.status || 'pendiente');

            const getStatusColor = (s) => {
                const st = (s || '').toLowerCase();
                if (st.includes('aprobado') || st.includes('done') || st.includes('complete')) return 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20';
                if (st.includes('rechazado')) return 'bg-red-500/10 text-red-400 border-red-500/20';
                return 'bg-amber-500/10 text-amber-400 border-amber-500/20';
            };

            const handleSave = async () => {
                setIsSaving(true);
                await onUpdate(task.id, { observaciones: observation, status: status });
                setIsSaving(false);
            };

            return (
                <div className="bg-[#151B2B] rounded-xl border border-[#2D3748] p-5 shadow-sm hover:border-blue-500/30 transition-colors">
                    <div className="flex justify-between items-start mb-4">
                        <div>
                            <h3 className="font-semibold text-lg text-white mb-1">{task.name}</h3>
                            <p className="text-sm text-slate-400 line-clamp-2">{task.description || 'Sin descripción adicional'}</p>
                        </div>
                        <span className={`px-3 py-1 rounded-full text-xs font-bold border ${getStatusColor(status)} uppercase`}>
                            {status}
                        </span>
                    </div>

                    <div className="space-y-3">
                        {/* Botones de Estado */}
                        <div className="flex gap-2 overflow-x-auto pb-2">
                            {['Pendiente', 'Aprobado', 'Rechazado'].map(opt => (
                                <button
                                    key={opt}
                                    onClick={() => setStatus(opt.toLowerCase())}
                                    className={`px-3 py-1.5 rounded-lg text-xs font-medium border transition-colors ${
                                        status === opt.toLowerCase() 
                                        ? 'bg-blue-600 border-blue-500 text-white' 
                                        : 'bg-[#0B0F19] border-[#2D3748] text-slate-400 hover:text-white'
                                    }`}
                                >
                                    {opt}
                                </button>
                            ))}
                        </div>

                        {/* Campo Observaciones */}
                        <div>
                            <label className="block text-xs text-slate-500 mb-1">Observaciones / Respuesta</label>
                            <textarea 
                                className="w-full bg-[#0B0F19] border border-[#2D3748] rounded-lg p-3 text-sm text-slate-200 focus:border-blue-500 outline-none resize-none"
                                rows="2"
                                value={observation}
                                onChange={(e) => setObservation(e.target.value)}
                                placeholder="Añade una nota..."
                            />
                        </div>

                        <div className="flex justify-end pt-2">
                            <Button onClick={handleSave} variant="secondary" loading={isSaving} className="text-xs py-1.5 h-8">
                                <Icons.Save className="w-3 h-3 mr-1" /> Guardar Cambios
                            </Button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD PRINCIPAL ---
        const Dashboard = ({ tenant, onLogout }) => {
            const [decisions, setDecisions] = useState([]);
            const [loading, setLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');

            // Función para cargar datos desde N8N
            const fetchDecisions = async () => {
                setLoading(true);
                try {
                    // Enviamos los datos del tenant actual al router de N8N
                    console.log("Petición a N8N:", { action: 'get_decisions', tenantId: tenant.id });
                    
                    const response = await fetch(`${ENDPOINTS.OPERATIONS}?t=${Date.now()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'get_decisions',
                            tenantId: tenant.id, // ID para el Switch en N8N
                            listId: tenant.listId // ID de la lista ClickUp objetivo
                        })
                    });
                    
                    const text = await response.text();
                    console.log("Respuesta N8N:", text);
                    
                    let data = [];
                    try { data = text ? JSON.parse(text) : []; } catch (e) { console.error("Error JSON:", e); }
                    
                    // Asegurar que es un array
                    const tasks = Array.isArray(data) ? data : (data.tasks || []);
                    setDecisions(tasks);
                } catch (err) {
                    console.error("Error fetching decisions", err);
                } finally {
                    setLoading(false);
                }
            };

            // Cargar al inicio
            useEffect(() => {
                if (tenant) fetchDecisions();
            }, [tenant]);

            const handleUpdateDecision = async (taskId, updates) => {
                try {
                    await fetch(`${ENDPOINTS.OPERATIONS}?t=${Date.now()}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'update_decision',
                            tenantId: tenant.id,
                            taskId: taskId,
                            updates: updates
                        })
                    });
                    // Recargamos tras actualizar
                    fetchDecisions();
                } catch (err) { alert("Error actualizando"); }
            };

            const filteredDecisions = decisions.filter(d => 
                (d.name || '').toLowerCase().includes(searchTerm.toLowerCase())
            );

            return (
                <div className="min-h-screen bg-[#0B0F19] text-slate-200">
                    {/* Navbar */}
                    <nav className="bg-[#151B2B] border-b border-[#2D3748] sticky top-0 z-50">
                        <div className="max-w-5xl mx-auto px-4 py-4 flex justify-between items-center">
                            <div className="flex items-center gap-4">
                                {tenant.logo ? (
                                    <img src={tenant.logo} alt={tenant.name} className="h-10 w-auto rounded" />
                                ) : (
                                    <div className="h-10 w-10 bg-slate-700 rounded flex items-center justify-center font-bold">
                                        {tenant.name ? tenant.name.charAt(0) : 'T'}
                                    </div>
                                )}
                                <div>
                                    <h1 className="font-bold text-white leading-tight">{tenant.name || 'Empresa'}</h1>
                                    <p className="text-xs text-slate-500">Portal de Decisiones</p>
                                </div>
                            </div>
                            <Button variant="ghost" onClick={onLogout} className="p-2">
                                <Icons.LogOut className="w-5 h-5" />
                            </Button>
                        </div>
                    </nav>

                    {/* Contenido Principal */}
                    <main className="max-w-5xl mx-auto p-4 md:p-8">
                        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                            <div>
                                <h2 className="text-2xl font-bold text-white">Decisiones Pendientes</h2>
                                <p className="text-slate-400">Revisa y actualiza el estado de los asuntos clave.</p>
                            </div>
                            
                            <div className="flex gap-2 w-full md:w-auto">
                                <div className="relative w-full md:w-64">
                                    <div className="absolute left-3 top-3 pointer-events-none">
                                        <Icons.Search className="w-4 h-4 text-slate-500" />
                                    </div>
                                    <input 
                                        type="text" 
                                        placeholder="Filtrar..." 
                                        value={searchTerm} 
                                        onChange={e => setSearchTerm(e.target.value)} 
                                        className="w-full bg-[#151B2B] border border-[#2D3748] rounded-lg pl-9 pr-4 py-2.5 text-sm focus:border-blue-500 outline-none text-white" 
                                    />
                                </div>
                                <Button onClick={fetchDecisions} variant="secondary" loading={loading} className="px-3">
                                    <Icons.RefreshCw className={`w-4 h-4 ${loading ? 'animate-spin' : ''}`} />
                                </Button>
                            </div>
                        </div>

                        {/* Estados de Carga y Lista */}
                        {loading ? (
                            <div className="flex justify-center py-20">
                                <Icons.Loader2 className="w-8 h-8 text-blue-500 animate-spin" />
                            </div>
                        ) : filteredDecisions.length > 0 ? (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {filteredDecisions.map(task => (
                                    <DecisionCard key={task.id} task={task} onUpdate={handleUpdateDecision} />
                                ))}
                            </div>
                        ) : (
                            <div className="text-center py-12 bg-[#151B2B]/50 rounded-xl border border-dashed border-[#2D3748]">
                                <div className="flex justify-center mb-3">
                                    <Icons.CheckCircle2 className="w-10 h-10 text-slate-600" />
                                </div>
                                <p className="text-slate-500">No hay decisiones pendientes (o pulsa refrescar).</p>
                                <Button onClick={fetchDecisions} variant="ghost" className="mt-2 text-blue-400">
                                    Cargar Datos
                                </Button>
                            </div>
                        )}
                    </main>
                </div>
            );
        };

        // --- APP ROOT ---
        const App = () => {
            const [tenant, setTenant] = useState(null);

            // Persistencia simple de sesión
            useEffect(() => {
                const saved = sessionStorage.getItem('saas_tenant');
                if (saved) {
                    try { setTenant(JSON.parse(saved)); } catch(e) {}
                }
            }, []);

            const handleLogin = (tenantData) => {
                setTenant(tenantData);
                sessionStorage.setItem('saas_tenant', JSON.stringify(tenantData));
            };

            const handleLogout = () => {
                setTenant(null);
                sessionStorage.removeItem('saas_tenant');
            };

            if (!tenant) {
                return <LoginScreen onLogin={handleLogin} />;
            }

            return <Dashboard tenant={tenant} onLogout={handleLogout} />;
        };

        // Renderizado (Compatible React 17/18)
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
