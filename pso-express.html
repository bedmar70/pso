<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>5.1. PSO Gesti√≥n: Acceso Seguro</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    body { background-color: #050505; color: #e2e8f0; font-family: sans-serif; }
    
    /* Input Style */
    .cyber-input { 
      background: rgba(255, 255, 255, 0.05); 
      border: 1px solid #333; 
      color: #00f3ff; 
      width: 100%; 
      border-radius: 0.5rem; 
      padding: 0.75rem; 
      font-size: 0.95rem;
      transition: all 0.3s;
    }
    .cyber-input:focus { outline: none; border-color: #00f3ff; box-shadow: 0 0 15px rgba(0, 243, 255, 0.2); }
    .cyber-input::placeholder { color: #6b7280; opacity: 1; }
    
    .hidden-force { display: none !important; }
    label { font-size: 0.75rem; text-transform: uppercase; color: #9ca3af; margin-bottom: 0.25rem; display: block; letter-spacing: 0.05em; }
    label.required { color: #00f3ff; font-weight: bold; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #00f3ff; }

    /* Animaci√≥n simple */
    .fade-in { animation: fadeIn 0.5s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body class="p-4 flex justify-center items-center min-h-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

  <div id="viewLogin" class="w-full max-w-md bg-gray-900/90 p-8 rounded-2xl border border-[#00f3ff]/30 shadow-[0_0_30px_rgba(0,243,255,0.1)] backdrop-blur-sm fade-in">
    <div class="text-center mb-8">
      <h1 class="text-3xl font-bold text-white mb-2">PSO <span class="text-[#00f3ff]">ACCESS</span></h1>
      <p class="text-gray-400 text-xs tracking-widest">IDENTIFICACI√ìN REQUERIDA</p>
    </div>

    <form id="loginForm" class="space-y-6">
      <div>
        <label>Email Corporativo</label>
        <input type="email" id="loginEmail" class="cyber-input text-center" placeholder="usuario@pso.com" required>
      </div>
      <div>
        <label>Contrase√±a</label>
        <input type="password" id="loginPass" class="cyber-input text-center" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
      </div>
      <button type="submit" id="btnLogin" class="w-full bg-[#00f3ff] text-black font-bold py-3 rounded hover:bg-white transition-all shadow-lg hover:shadow-[#00f3ff]/50">
        INICIAR SESI√ìN
      </button>
    </form>
  </div>


  <div id="viewApp" class="w-full max-w-4xl bg-gray-900/90 p-6 rounded-xl border border-gray-700 shadow-2xl hidden-force fade-in">
    
    <div class="border-b border-gray-700 pb-4 mb-6 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-white">PSO <span class="text-[#00f3ff]">SYSTEM</span></h1>
        <p class="text-xs text-gray-400 mt-1">PANEL DE GESTI√ìN v5.1</p>
      </div>
      <div class="text-right text-xs">
        <div class="text-[#00f3ff] font-bold" id="displayUser">USUARIO</div>
        <button onclick="logout()" class="text-red-400 hover:text-white underline mt-1">Cerrar Sesi√≥n</button>
      </div>
    </div>

    <form id="gestionForm" class="space-y-6">
      
      <div class="col-span-1 md:col-span-2">
        <label class="required">TIPO DE GESTI√ìN (Selecciona para empezar)</label>
        <select id="tipoGestion" name="tipo_gestion_comercial" class="cyber-input text-lg font-bold bg-black border-[#00f3ff]" required>
          <option value="">‚ñº SELECCIONAR OPERACI√ìN...</option>
          <option value="Alta nueva">üöÄ ALTA NUEVA</option>
          <option value="Modificaci√≥n">üìù MODIFICACI√ìN</option>
          <option value="Consultas - Varios">‚ùì CONSULTAS VARIOS</option>
          <option value="Consulta - Precio Clich√©">üí∞ CONSULTA PRECIO CLICH√âS</option>
          <option value="Consulta - Dise√±o Plano">üìê CONSULTA PLANO</option>
          <option value="Consulta - Dise√±o">üé® CONSULTA DISE√ëO</option>
        </select>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <div id="campo_nombreSolicitante" class="hidden-force col-span-1">
          <label class="required">Solicitante</label>
          <input type="text" name="nombreSolicitante" id="inputNombreSolicitante" class="cyber-input" required>
        </div>
        <div id="campo_emailSolicitante" class="hidden-force col-span-1">
          <label class="required">Email de Contacto</label>
          <input type="email" name="emailSolicitante" id="inputEmailSolicitante" class="cyber-input" required>
        </div>

        <div id="campo_nombreProyecto" class="hidden-force col-span-1 md:col-span-2">
          <label class="required">Nombre del Proyecto / Identificador</label>
          <input type="text" name="nombreProyecto" class="cyber-input" placeholder="Ej: Proyecto Alpha - Envase 500ml">
        </div>

        <div id="campo_cliente" class="hidden-force col-span-1 md:col-span-2">
          <label>Vincular Cliente (Base de Datos)</label>
          <div class="relative">
            <input type="text" id="searchCliente" class="cyber-input pl-10" placeholder="Escribe el nombre del cliente para buscar..." autocomplete="off">
            <div id="resCliente" class="absolute z-50 w-full bg-gray-900 border border-[#00f3ff] mt-1 rounded max-h-60 overflow-y-auto hidden shadow-xl"></div>
          </div>
          <div id="selCliente" class="mt-2 p-3 bg-[#00f3ff]/10 border border-[#00f3ff]/30 text-[#00f3ff] text-sm rounded hidden flex items-center gap-2">
            <span>‚úÖ</span> <span id="selClienteText"></span>
          </div>
          <input type="hidden" name="cliente" id="inputCliente"> 
        </div>

        <div id="campo_buscarProyecto" class="hidden-force col-span-1 md:col-span-2">
          <label>Vincular Proyecto Existente</label>
          <div class="relative">
            <input type="text" id="searchProyecto" class="cyber-input pl-10" placeholder="Escribe ID o nombre de la tarea..." autocomplete="off">
            <div id="resProyecto" class="absolute z-50 w-full bg-gray-900 border border-[#00f3ff] mt-1 rounded max-h-60 overflow-y-auto hidden shadow-xl"></div>
          </div>
          <div id="selProyecto" class="mt-2 p-3 bg-[#00f3ff]/10 border border-[#00f3ff]/30 text-[#00f3ff] text-sm rounded hidden flex items-center gap-2">
            <span>‚úÖ</span> <span id="selProyectoText"></span>
          </div>
          <input type="hidden" name="proyecto_relacionado" id="inputProyecto">
        </div>

        <div id="campo_descripcion" class="hidden-force col-span-1 md:col-span-2">
          <label class="required">Descripci√≥n Detallada</label>
          <textarea name="descripcion" rows="4" class="cyber-input" placeholder="Describe los detalles de la solicitud, especificaciones, cambios requeridos..."></textarea>
        </div>

        <div id="campo_prioridadBoceto" class="hidden-force col-span-1">
          <label>Nivel de Prioridad</label>
          <select name="prioridadBoceto" class="cyber-input">
            <option value="Normal">Normal (Est√°ndar)</option>
            <option value="Prioritario">Prioritario</option>
            <option value="Urgente">üö® URGENTE</option>
          </select>
        </div>

        <div id="campo_necesitaCosteCliches" class="hidden-force col-span-1">
          <label>¬øRequiere Coste de Clich√©s?</label>
          <select name="necesitaCosteCliches" class="cyber-input">
            <option value="">- Seleccionar -</option>
            <option value="SI">SI</option>
            <option value="NO">NO</option>
          </select>
        </div>

        <div id="campo_tipoImpresion" class="hidden-force col-span-1">
          <label>Modo de Impresi√≥n</label>
          <select name="tipoImpresion" class="cyber-input">
            <option value="">- Seleccionar -</option>
            <option value="Interior">Interior</option>
            <option value="Exterior">Exterior</option>
          </select>
        </div>

        <div id="campo_referenciaPSO" class="hidden-force col-span-1">
          <label>Referencia Interna PSO</label>
          <input type="text" name="referenciaPSO" class="cyber-input" placeholder="Ref. num√©rica o c√≥digo">
        </div>
        <div id="campo_materiales" class="hidden-force col-span-1 md:col-span-2">
          <label>Materiales / Sustrato</label>
          <input type="text" name="materiales" class="cyber-input" placeholder="Ej: Polietileno, Complejo, Papel...">
        </div>
        
        <div id="campo_enlaceDiseno" class="hidden-force col-span-1 md:col-span-2">
          <label>Enlace a Archivos (Nube)</label>
          <input type="url" name="enlaceDiseno" class="cyber-input" placeholder="https://drive.google.com/...">
          <p class="text-xs text-gray-400 mt-2 leading-relaxed">
            ‚ÑπÔ∏è Los archivos adjuntos se podr√°n insertar m√°s abajo en el campo "Adjuntar Archivos". 
            Si los mismos pesan <span class="text-[#00f3ff] font-bold">m√°s de 10 Megas</span>, 
            por favor enviar con WeTransfer o servicio similar indicando aqu√≠ la URL.
          </p>
        </div>

        <div id="campo_presupuesto" class="hidden-force col-span-1">
          <label>Presupuesto Estimado (‚Ç¨)</label>
          <input type="number" name="presupuesto" class="cyber-input" step="0.01" placeholder="0.00">
        </div>
        <div id="campo_complejidad" class="hidden-force col-span-1">
          <label>Nivel de Complejidad (1-4)</label>
          <div class="flex items-center gap-4">
            <span class="text-xs text-gray-500">Baja</span>
            <input type="range" name="complejidad" min="1" max="4" class="w-full accent-[#00f3ff]">
            <span class="text-xs text-[#00f3ff]">Alta</span>
          </div>
        </div>
        <div id="campo_fechaPrometida" class="hidden-force col-span-1">
          <label>Deadline (Fecha L√≠mite)</label>
          <input type="date" name="fechaPrometida" class="cyber-input text-gray-300">
        </div>
        <div id="campo_observaciones" class="hidden-force col-span-1 md:col-span-2">
          <label>Notas Adicionales</label>
          <textarea name="observaciones" rows="2" class="cyber-input" placeholder="Cualquier otra informaci√≥n relevante..."></textarea>
        </div>

        <div id="campo_metricasTecnicas" class="hidden-force col-span-1 md:col-span-2 bg-white/5 p-5 rounded border border-white/10">
           <div class="text-[#00f3ff] font-bold text-sm mb-4 border-b border-white/10 pb-2">PAR√ÅMETROS T√âCNICOS</div>
           <div class="grid grid-cols-3 gap-6">
             <div><label>N¬∫ Ca√≠das</label><input type="number" name="numCaidas" class="cyber-input text-center" placeholder="0"></div>
             <div><label>Repeticiones</label><input type="number" name="numRepeticiones" class="cyber-input text-center" placeholder="0"></div>
             <div><label>N¬∫ Colores</label><input type="number" name="numColores" class="cyber-input text-center" placeholder="0"></div>
             <div class="col-span-3">
               <label>Aplicaci√≥n de Barnices</label>
               <select name="barnices" class="cyber-input">
                 <option value="">- Seleccionar -</option>
                 <option value="SI">SI</option>
                 <option value="NO">NO</option>
               </select>
             </div>
           </div>
        </div>

        <div id="campo_archivos" class="hidden-force col-span-1 md:col-span-2 border-2 border-dashed border-gray-600 p-8 text-center rounded-xl cursor-pointer hover:border-[#00f3ff] hover:bg-[#00f3ff]/5 transition-all">
           <div class="text-3xl mb-2">üìé</div>
           <p class="text-gray-300 font-bold">Adjuntar Archivos</p>
           <p class="text-xs text-gray-500 mt-1">Haz clic para explorar o arrastra archivos aqu√≠</p>
           <input type="file" id="archivos" multiple class="hidden">
           <div id="listaArchivos" class="mt-4 space-y-2 text-sm text-left"></div>
        </div>

      </div>

      <button type="submit" id="btnEnviar" class="w-full bg-gradient-to-r from-[#00f3ff] to-blue-600 text-black font-bold text-lg py-4 rounded-xl shadow-[0_0_20px_rgba(0,243,255,0.3)] hover:scale-[1.01] transition-transform">
        TRANSMITIR DATOS AL SISTEMA
      </button>

    </form>
  </div>

  <script>
    // URLS N8N - ASEG√öRATE DE QUE SEAN CORRECTAS
    const WEBHOOKS = {
      login: 'https://n8n.escueladeefectividad.com/webhook/pso-login-comerciales',
      buscarProyectos: 'https://n8n.escueladeefectividad.com/webhook/pso-buscar-proyectos',
      buscarClientes: 'https://n8n.escueladeefectividad.com/webhook/pso-buscar-clientes',
      crearTarea: 'https://n8n.escueladeefectividad.com/webhook/pso-crear-tarea-gestion'
    };

    // --- L√ìGICA DE LOGIN ---
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const pass = document.getElementById('loginPass').value;
      const btn = document.getElementById('btnLogin');
      
      btn.disabled = true;
      btn.innerText = 'VERIFICANDO...';

      try {
        const res = await fetch(WEBHOOKS.login, { 
          method: 'POST', 
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ email, password: pass }) 
        });
        const data = await res.json();
        
        console.log('Respuesta Login:', data); // Ver en consola F12

        if(data.success) {
          // Ocultar Login / Mostrar App
          document.getElementById('viewLogin').classList.add('hidden-force');
          document.getElementById('viewApp').classList.remove('hidden-force');
          
          // RESCATAR DATOS: Lee 'nombre' O 'usuario.nombre'
          const nombreUsuario = data.nombre || (data.usuario && data.usuario.nombre) || "Usuario";
          const emailUsuario = data.email || (data.usuario && data.usuario.email) || email;

          // Rellenar campos (AHORA EDITABLES)
          document.getElementById('inputNombreSolicitante').value = nombreUsuario;
          document.getElementById('inputEmailSolicitante').value = emailUsuario;
          document.getElementById('displayUser').textContent = nombreUsuario.toUpperCase();

        } else {
          Swal.fire('Acceso Denegado', 'Credenciales incorrectas.', 'error');
        }
      } catch (err) {
        console.error(err);
        Swal.fire('Error', 'No se pudo conectar con el servidor.', 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'INICIAR SESI√ìN';
      }
    });

    // Funci√≥n Logout
    window.logout = function() {
      window.location.reload();
    }

    // --- VISIBILIDAD DE CAMPOS ---
    // AQU√ç ES DONDE HE HECHO EL CAMBIO PARA OCULTAR PRESUPUESTO Y COMPLEJIDAD EN "CLICH√â"
    const TIPOS = {
      'Alta nueva': ['nombreSolicitante', 'emailSolicitante', 'nombreProyecto', 'descripcion', 'cliente', 'referenciaPSO', 'prioridadBoceto', 'necesitaCosteCliches', 'tipoImpresion', 'materiales', 'enlaceDiseno', 'archivos', 'presupuesto', 'complejidad', 'fechaPrometida'],
      'Modificaci√≥n': ['nombreSolicitante', 'emailSolicitante', 'nombreProyecto', 'descripcion', 'cliente', 'referenciaPSO', 'prioridadBoceto', 'necesitaCosteCliches', 'tipoImpresion', 'materiales', 'enlaceDiseno', 'archivos', 'presupuesto', 'complejidad', 'fechaPrometida', 'observaciones', 'buscarProyecto'],
      'Consultas - Varios': ['nombreSolicitante', 'emailSolicitante', 'descripcion', 'archivos', 'enlaceDiseno', 'observaciones'],
      // ELIMINADOS DE AQU√ç: 'presupuesto' Y 'complejidad'
      'Consulta - Precio Clich√©': ['nombreSolicitante', 'emailSolicitante', 'nombreProyecto', 'descripcion', 'cliente', 'referenciaPSO', 'prioridadBoceto', 'necesitaCosteCliches', 'tipoImpresion', 'materiales', 'enlaceDiseno', 'archivos', 'fechaPrometida', 'observaciones', 'metricasTecnicas'],
      'Consulta - Dise√±o Plano': ['descripcion', 'archivos', 'presupuesto', 'complejidad', 'fechaPrometida', 'emailSolicitante'],
      'Consulta - Dise√±o': ['descripcion', 'archivos', 'presupuesto', 'complejidad', 'fechaPrometida', 'emailSolicitante']
    };

    document.getElementById('tipoGestion').addEventListener('change', function(e) {
      const seleccion = e.target.value;
      document.querySelectorAll('[id^="campo_"]').forEach(el => {
        el.classList.add('hidden-force');
        el.style.display = 'none';
      });
      if (!seleccion) return;
      (TIPOS[seleccion] || []).forEach(id => {
        const el = document.getElementById('campo_' + id);
        if(el) { el.classList.remove('hidden-force'); el.style.display = 'block'; }
        if(el && el.classList.contains('md:col-span-2') && window.innerWidth >= 768) el.style.gridColumn = 'span 2 / span 2';
      });
    });

    // --- B√öSQUEDA ---
    let debounceTimer;
    async function buscarEnN8N(query, url, contenedorResultados, tipo) {
      contenedorResultados.innerHTML = '<div class="p-3 text-[#00f3ff] text-xs">Conectando...</div>';
      contenedorResultados.classList.remove('hidden');
      try {
        const res = await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ query }) });
        const datos = await res.json();
        const items = datos.map(d => d.json ? d.json : d).filter(Boolean);

        if(items.length === 0) {
            contenedorResultados.innerHTML = '<div class="p-3 text-gray-500 text-xs">Sin resultados</div>';
            return;
        }

        contenedorResultados.innerHTML = items.map(item => `
            <div class="p-3 hover:bg-[#00f3ff]/10 cursor-pointer border-b border-gray-800 transition-colors"
                 onclick='seleccionarItem(${JSON.stringify(item).replace(/'/g, "&apos;")}, "${tipo}")'>
               <div class="font-bold text-gray-200 text-sm">${item.name}</div>
               <div class="text-[10px] text-[#00f3ff] mt-1">ID: ${item.id || 'N/A'}</div>
            </div>
        `).join('');
      } catch (err) { contenedorResultados.innerHTML = '<div class="p-3 text-red-500 text-xs">Error</div>'; }
    }

    window.seleccionarItem = function(item, tipo) {
       if(tipo === 'cliente') {
           document.getElementById('searchCliente').value = '';
           document.getElementById('resCliente').classList.add('hidden');
           document.getElementById('selClienteText').textContent = item.name;
           document.getElementById('selCliente').classList.remove('hidden');
           document.getElementById('inputCliente').value = item.name; 
           window.clienteSeleccionado = item;
       } else {
           document.getElementById('searchProyecto').value = '';
           document.getElementById('resProyecto').classList.add('hidden');
           document.getElementById('selProyectoText').textContent = item.name;
           document.getElementById('selProyecto').classList.remove('hidden');
           document.getElementById('inputProyecto').value = item.id;
           window.proyectoSeleccionado = item;
       }
    };

    document.getElementById('searchCliente').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        if(e.target.value.length < 2) { document.getElementById('resCliente').classList.add('hidden'); return; }
        debounceTimer = setTimeout(() => buscarEnN8N(e.target.value, WEBHOOKS.buscarClientes, document.getElementById('resCliente'), 'cliente'), 300);
    });
    document.getElementById('searchProyecto').addEventListener('input', (e) => {
        clearTimeout(debounceTimer);
        if(e.target.value.length < 2) { document.getElementById('resProyecto').classList.add('hidden'); return; }
        debounceTimer = setTimeout(() => buscarEnN8N(e.target.value, WEBHOOKS.buscarProyectos, document.getElementById('resProyecto'), 'proyecto'), 300);
    });

    // --- ARCHIVOS ---
    const fileInput = document.getElementById('archivos');
    let archivosSeleccionados = [];
    document.getElementById('campo_archivos').addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
        archivosSeleccionados = [...archivosSeleccionados, ...Array.from(e.target.files)];
        document.getElementById('listaArchivos').innerHTML = archivosSeleccionados.map((f, i) => `
            <div class="flex justify-between items-center bg-gray-800 p-2 rounded border border-gray-700">
                <span class="text-gray-300 truncate">${f.name}</span>
                <span class="text-[#00f3ff] text-xs">${(f.size/1024).toFixed(0)} KB</span>
            </div>
        `).join('');
    });

    // --- ENV√çO ---
    document.getElementById('gestionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnEnviar');
        btn.disabled = true;
        btn.innerHTML = '<span class="animate-pulse">TRANSMITIENDO...</span>';

        try {
            const formData = new FormData(e.target);
            
            // INYECTAR ROLLUPS EN DESCRIPCI√ìN
            let descFinal = formData.get('descripcion') || "";
            let infoRollup = "";
            if(window.clienteSeleccionado) {
                 formData.set('cliente', window.clienteSeleccionado.name);
                 infoRollup += `\n\nüìå CLIENTE VINCULADO: ${window.clienteSeleccionado.name}`;
            }
            if(window.proyectoSeleccionado) {
                 formData.set('proyecto_relacionado', window.proyectoSeleccionado.id);
                 infoRollup += `\nüîó PROYECTO RELACIONADO: ${window.proyectoSeleccionado.name} (ID: ${window.proyectoSeleccionado.id})`;
            }
            if(infoRollup) {
                formData.set('descripcion', descFinal + infoRollup);
            }

            archivosSeleccionados.forEach((f, i) => formData.append(`archivo_${i}`, f));

            const res = await fetch(WEBHOOKS.crearTarea, { method: 'POST', body: formData });
            
            if(res.ok) {
                Swal.fire({
                    title: '¬°SOLICITUD ENVIADA!',
                    text: 'Datos registrados correctamente.',
                    icon: 'success',
                    background: '#111',
                    color: '#fff',
                    confirmButtonColor: '#00f3ff',
                    confirmButtonText: '<span style="color:black; font-weight:bold">ENTENDIDO</span>'
                });
                e.target.reset();
                archivosSeleccionados = [];
                document.getElementById('listaArchivos').innerHTML = '';
                document.getElementById('selCliente').classList.add('hidden');
                document.getElementById('selProyecto').classList.add('hidden');
                window.clienteSeleccionado = null;
                window.proyectoSeleccionado = null;
                document.getElementById('tipoGestion').dispatchEvent(new Event('change'));
            } else {
                throw new Error('Error en servidor');
            }
        } catch (err) {
            Swal.fire('Error', 'No se pudo contactar con el servidor.', 'error');
        } finally {
            btn.disabled = false;
            btn.innerText = 'TRANSMITIR DATOS AL SISTEMA';
        }
    });
  </script>
</body>
</html>
