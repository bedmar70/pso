<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Viphery ¬∑ Alta de Medici√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00f5d4',
            darkbg: '#0b0f19',
            cardbg: '#121826'
          },
          boxShadow: {
            neon: '0 0 0 1px rgba(0,245,212,0.25), 0 0 28px rgba(0,245,212,0.08)'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-darkbg text-gray-200 min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-3xl bg-cardbg rounded-2xl shadow-xl p-8 space-y-8">

    <div class="border-b border-gray-700 pb-4">
      <h1 class="text-2xl font-bold text-primary">Viphery</h1>
      <p class="text-sm text-gray-400">Alta de Medici√≥n</p>
    </div>

    <form id="medicionForm" class="space-y-6" enctype="multipart/form-data">
      <input type="hidden" name="list_id" id="list_id" value="" />

      <div class="relative">
        <label class="block text-sm mb-1">Proyecto (lista de ClickUp)</label>
        <input
          type="text"
          id="projectSearch"
          name="projectSearch"
          autocomplete="off"
          required
          placeholder="Empieza a escribir para buscar proyectos..."
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        />

        <div
          id="projectDropdown"
          class="hidden absolute z-20 mt-2 w-full rounded-xl border border-gray-700 bg-black/60 backdrop-blur shadow-neon overflow-hidden"
        >
          <div id="projectResults" class="max-h-64 overflow-auto"></div>
          <div id="projectEmpty" class="hidden px-4 py-3 text-sm text-gray-400">
            No se encontraron proyectos.
          </div>
        </div>

        <p id="projectHint" class="mt-2 text-xs text-gray-500">
          Selecciona un proyecto del desplegable. (Esto define d√≥nde se crea la medici√≥n)
        </p>
      </div>

      <div>
        <label class="block text-sm mb-1">Nombre de la medici√≥n (extracto)</label>
        <input
          type="text"
          name="taskName"
          id="taskName"
          required
          placeholder="Ej. Medici√≥n cocina ¬∑ Portal + escalera"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        />
      </div>

      <div>
        <label class="block text-sm mb-1">Descripci√≥n / notas (se guarda en Content)</label>
        <textarea
          name="description"
          id="description"
          rows="5"
          placeholder="Describe el contexto de la medici√≥n, zonas, incidencias, etc‚Ä¶"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
      </div>

      <div>
        <label class="block text-sm mb-1">Electrodom√©sticos (campo ClickUp: Electrodomesticos)</label>
        <textarea
          name="electrodomesticos"
          id="electrodomesticos"
          rows="4"
          placeholder="Lista de electrodom√©sticos / marcas / medidas relevantes‚Ä¶"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
      </div>

      <div>
        <label class="block text-sm mb-1">Observaciones (campo ClickUp: Observaciones Medicion)</label>
        <textarea
          name="observaciones"
          id="observaciones"
          rows="4"
          placeholder="Observaciones adicionales‚Ä¶"
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-primary"
        ></textarea>
      </div>

      <div>
        <label class="block text-sm mb-2">Fotos (se adjuntan a la tarea)</label>

        <label
          for="photos"
          class="flex items-center justify-center w-full px-4 py-6 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer hover:border-primary hover:shadow-neon transition"
        >
          <span class="text-sm text-gray-400">Haz clic o arrastra fotos aqu√≠</span>
        </label>

        <input
          id="photos"
          type="file"
          accept="image/*"
          multiple
          class="hidden"
        />

        <ul id="photosList" class="mt-4 space-y-2 text-sm text-gray-300"></ul>
      </div>

      <div>
        <label class="block text-sm mb-2">Hoja de medici√≥n (archivo t√©cnico)</label>

        <label
          for="hoja"
          class="flex items-center justify-center w-full px-4 py-6 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer hover:border-primary hover:shadow-neon transition"
        >
          <span class="text-sm text-gray-400">Haz clic o arrastra la hoja de medici√≥n aqu√≠</span>
        </label>

        <input
          id="hoja"
          type="file"
          multiple
          class="hidden"
        />

        <ul id="hojaList" class="mt-4 space-y-2 text-sm text-gray-300"></ul>
      </div>

      <div class="pt-2">
        <button
          id="submitBtn"
          type="submit"
          class="w-full bg-primary text-black font-semibold py-3 rounded-xl hover:opacity-90 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Enviar medici√≥n
        </button>

        <p id="statusMsg" class="mt-3 text-sm text-gray-400 hidden"></p>
      </div>
    </form>
  </div>

  <script>
    // URL Webhooks
    const SEARCH_PROJECTS_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-buscar-proyectos';
    const CREATE_MEDICION_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-crear-medicion';

    // ---------- helpers ----------
    function escapeHtml(str) {
      return String(str)
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#039;');
    }

    function bytesToHuman(bytes) {
      const units = ['B','KB','MB','GB'];
      let i = 0;
      let n = bytes;
      while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
      return `${n.toFixed(i === 0 ? 0 : 1)} ${units[i]}`;
    }

    // ---------- Adjuntos con eliminaci√≥n CORRECTA ----------
    let photosStore = [];
    let hojaStore = [];

    const photosInput = document.getElementById('photos');
    const hojaInput = document.getElementById('hoja');
    const photosList = document.getElementById('photosList');
    const hojaList = document.getElementById('hojaList');

    // Listener Fotos
    photosInput.addEventListener('change', () => {
      photosStore = photosStore.concat(Array.from(photosInput.files));
      photosInput.value = ''; // Reset para permitir seleccionar lo mismo si se borr√≥
      updatePhotosUI();
    });

    // Listener Hoja
    hojaInput.addEventListener('change', () => {
      hojaStore = hojaStore.concat(Array.from(hojaInput.files));
      hojaInput.value = ''; 
      updateHojaUI();
    });

    // Funci√≥n espec√≠fica para pintar Fotos
    function updatePhotosUI() {
      renderFiles(photosStore, photosList, (indexToRemove) => {
        photosStore.splice(indexToRemove, 1);
        updatePhotosUI(); // Volvemos a pintar tras borrar
      });
    }

    // Funci√≥n espec√≠fica para pintar Hojas
    function updateHojaUI() {
      renderFiles(hojaStore, hojaList, (indexToRemove) => {
        hojaStore.splice(indexToRemove, 1);
        updateHojaUI();
      });
    }

    // Funci√≥n gen√©rica de renderizado
    function renderFiles(store, ul, onRemoveCallback) {
      ul.innerHTML = '';
      store.forEach((file, idx) => {
        const li = document.createElement('li');
        li.className = 'flex items-center justify-between bg-darkbg border border-gray-700 rounded-lg px-3 py-2 gap-3';

        const left = document.createElement('div');
        left.className = 'min-w-0';
        left.innerHTML = `<div class="truncate max-w-[520px]">üìé ${escapeHtml(file.name)}</div>
                          <div class="text-xs text-gray-400">${bytesToHuman(file.size)}</div>`;

        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'shrink-0 px-3 py-1 rounded-lg border border-gray-600 hover:border-primary hover:shadow-neon transition text-xs text-gray-200';
        btn.textContent = 'Eliminar';
        
        // Al hacer click, llamamos al callback con el √≠ndice actual
        btn.addEventListener('click', () => {
            onRemoveCallback(idx);
        });

        li.appendChild(left);
        li.appendChild(btn);
        ul.appendChild(li);
      });
    }

    // ---------- Proyecto: autocomplete / rollup ----------
    const projectSearch = document.getElementById('projectSearch');
    const listIdInput = document.getElementById('list_id');
    const dropdown = document.getElementById('projectDropdown');
    const results = document.getElementById('projectResults');
    const empty = document.getElementById('projectEmpty');

    let debounceTimer = null;
    let lastQuery = '';

    projectSearch.addEventListener('input', () => {
      listIdInput.value = ''; 
      scheduleSearch(projectSearch.value);
    });

    projectSearch.addEventListener('focus', () => {
      if (projectSearch.value.trim().length >= 1) {
        scheduleSearch(projectSearch.value, true);
      }
    });

    document.addEventListener('click', (e) => {
      const isInside = dropdown.contains(e.target) || projectSearch.contains(e.target);
      if (!isInside) hideDropdown();
    });

    function scheduleSearch(q, immediate = false) {
      const query = (q || '').trim();
      if (!query) { hideDropdown(); return; }
      if (debounceTimer) clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => searchProjects(query), immediate ? 0 : 250);
    }

    async function searchProjects(query) {
      if (query === lastQuery) return;
      lastQuery = query;

      showDropdown();
      results.innerHTML = `<div class="px-4 py-3 text-sm text-gray-400">Buscando...</div>`;
      empty.classList.add('hidden');

      try {
        const res = await fetch(SEARCH_PROJECTS_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });

        if (!res.ok) throw new Error('Error consultando proyectos');
        const data = await res.json();
        renderProjects(Array.isArray(data) ? data : []);
      } catch (err) {
        results.innerHTML = `<div class="px-4 py-3 text-sm text-red-400">Error consultando proyectos</div>`;
      }
    }

    function renderProjects(list) {
      results.innerHTML = '';
      if (!list.length) {
        empty.classList.remove('hidden');
        return;
      }
      empty.classList.add('hidden');

      list.forEach(item => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left px-4 py-3 hover:bg-primary/10 border-b border-gray-800 last:border-b-0';
        btn.innerHTML = `
          <div class="text-sm text-gray-100">${escapeHtml(item.name)}</div>
          <div class="text-xs text-gray-500">ID: ${escapeHtml(String(item.id))}</div>
        `;
        btn.addEventListener('click', () => {
          projectSearch.value = item.name;
          listIdInput.value = item.id;
          hideDropdown();
        });
        results.appendChild(btn);
      });
    }

    function showDropdown() { dropdown.classList.remove('hidden'); }
    function hideDropdown() { dropdown.classList.add('hidden'); }

    // ---------- Submit ----------
    const form = document.getElementById('medicionForm');
    const submitBtn = document.getElementById('submitBtn');
    const statusMsg = document.getElementById('statusMsg');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      if (!listIdInput.value) {
        showStatus('Selecciona un proyecto del desplegable (no vale texto libre).', true);
        projectSearch.focus();
        return;
      }

      submitBtn.disabled = true;
      showStatus('Enviando medici√≥n...', false);

      try {
        const formData = new FormData();

        // Campos texto
        formData.append('list_id', listIdInput.value);
        formData.append('taskName', document.getElementById('taskName').value || '');
        formData.append('description', document.getElementById('description').value || '');
        formData.append('electrodomesticos', document.getElementById('electrodomesticos').value || '');
        formData.append('observaciones', document.getElementById('observaciones').value || '');

        // === CORRECCI√ìN IMPORTANTE AQU√ç ===
        // N8N espera 'fotos' y 'hoja' (sin corchetes), y m√∫ltiples appends crean el array en N8N
        
        // 1. Fotos
        for (const f of photosStore) {
            formData.append('fotos', f);
        }

        // 2. Hoja Medici√≥n
        for (const f of hojaStore) {
            formData.append('hoja', f);
        }

        const res = await fetch(CREATE_MEDICION_URL, {
          method: 'POST',
          body: formData
        });

        if (!res.ok) throw new Error('Error al enviar');
        
        showStatus('‚úÖ Medici√≥n enviada correctamente.', false);

        // Reset total
        form.reset();
        listIdInput.value = '';
        lastQuery = '';
        hideDropdown();
        photosStore = [];
        hojaStore = [];
        updatePhotosUI(); // Limpia la lista visual
        updateHojaUI();   // Limpia la lista visual

        // Limpiar mensaje tras 3s
        setTimeout(() => {
          statusMsg.classList.add('hidden');
          statusMsg.textContent = '';
        }, 3000);

      } catch (err) {
        console.error(err);
        showStatus('‚ùå Error al enviar la medici√≥n. Revisa n8n (Executions).', true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    function showStatus(msg, isError) {
      statusMsg.textContent = msg;
      statusMsg.classList.remove('hidden');
      statusMsg.classList.toggle('text-red-400', !!isError);
      statusMsg.classList.toggle('text-gray-400', !isError);
    }
  </script>
</body>
</html>
