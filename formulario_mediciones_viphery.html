<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>v.1.0. Viphery ¬∑ Alta de Medici√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#00f5d4',
            darkbg: '#0b0f19',
            cardbg: '#121826'
          },
          boxShadow: {
            neon: '0 0 0 1px rgba(0,245,212,0.25), 0 0 28px rgba(0,245,212,0.08)'
          }
        }
      }
    }
  </script>
</head>

<body class="bg-darkbg text-gray-200 min-h-screen flex items-center justify-center px-4">
  <div class="w-full max-w-3xl bg-cardbg rounded-2xl shadow-xl p-8 space-y-8">

    <!-- HEADER -->
    <div class="border-b border-gray-700 pb-4">
      <h1 class="text-2xl font-bold text-primary">Viphery</h1>
      <p class="text-sm text-gray-400">Alta de Medici√≥n</p>
    </div>

    <form id="medicionForm" class="space-y-6" enctype="multipart/form-data">
      <input type="hidden" name="list_id" id="list_id" value="" />

      <!-- PROYECTO -->
      <div class="relative">
        <label class="block text-sm mb-1">Proyecto (lista de ClickUp)</label>
        <input id="projectSearch" autocomplete="off" required
          placeholder="Empieza a escribir para buscar proyectos..."
          class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2 focus:ring-2 focus:ring-primary"/>

        <div id="projectDropdown"
          class="hidden absolute z-20 mt-2 w-full rounded-xl border border-gray-700 bg-black/60 backdrop-blur shadow-neon">
          <div id="projectResults" class="max-h-64 overflow-auto"></div>
          <div id="projectEmpty" class="hidden px-4 py-3 text-sm text-gray-400">
            No se encontraron proyectos.
          </div>
        </div>
      </div>

      <!-- TEXTO -->
      <input id="taskName" required placeholder="Nombre de la medici√≥n"
        class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2"/>

      <textarea id="description" rows="4" placeholder="Descripci√≥n / notas"
        class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2"></textarea>

      <textarea id="electrodomesticos" rows="3" placeholder="Electrodom√©sticos"
        class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2"></textarea>

      <textarea id="observaciones" rows="3" placeholder="Observaciones"
        class="w-full rounded-lg bg-darkbg border border-gray-700 px-4 py-2"></textarea>

      <!-- FOTOS -->
      <div>
        <label class="block text-sm mb-2">Fotos</label>
        <label for="photos"
          class="flex items-center justify-center w-full px-4 py-6 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer">
          <span class="text-sm text-gray-400">Haz clic o arrastra fotos aqu√≠</span>
        </label>
        <input id="photos" type="file" accept="image/*" multiple class="hidden"/>
        <ul id="photosList" class="mt-4 space-y-2 text-sm"></ul>
      </div>

      <!-- HOJA -->
      <div>
        <label class="block text-sm mb-2">Hoja de medici√≥n</label>
        <label for="hoja"
          class="flex items-center justify-center w-full px-4 py-6 border-2 border-dashed border-gray-600 rounded-xl cursor-pointer">
          <span class="text-sm text-gray-400">Haz clic o arrastra archivo t√©cnico</span>
        </label>
        <input id="hoja" type="file" multiple class="hidden"/>
        <ul id="hojaList" class="mt-4 space-y-2 text-sm"></ul>
      </div>

      <button id="submitBtn"
        class="w-full bg-primary text-black font-semibold py-3 rounded-xl">
        Enviar medici√≥n
      </button>

      <p id="statusMsg" class="text-sm hidden"></p>
    </form>
  </div>

<script>
/* ===================== CONFIG ===================== */
const SEARCH_PROJECTS_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-buscar-proyectos';
const CREATE_MEDICION_URL = 'https://n8n.escueladeefectividad.com/webhook/viphery-crear-medicion';

/* ===================== HELPERS ===================== */
function normalizeFile(file, prefix) {
  const ext = file.name.split('.').pop();
  const clean =
    prefix +
    '_' +
    Date.now() +
    '_' +
    Math.random().toString(36).slice(2, 6) +
    '.' + ext;

  return new File([file], clean, { type: file.type });
}

function render(store, ul, onRemove) {
  ul.innerHTML = '';
  store.forEach((f, i) => {
    const li = document.createElement('li');
    li.className = 'flex justify-between border border-gray-700 rounded px-3 py-2';
    li.innerHTML = `<span class="truncate">üìé ${f.name}</span>`;
    const btn = document.createElement('button');
    btn.textContent = 'Eliminar';
    btn.onclick = () => onRemove(i);
    li.appendChild(btn);
    ul.appendChild(li);
  });
}

/* ===================== FILES ===================== */
let photosStore = [];
let hojaStore = [];

photos.onchange = () => {
  Array.from(photos.files).forEach(f =>
    photosStore.push(normalizeFile(f, 'foto'))
  );
  render(photosStore, photosList, i => {
    photosStore.splice(i, 1);
    render(photosStore, photosList, arguments.callee);
  });
  photos.value = '';
};

hoja.onchange = () => {
  Array.from(hoja.files).forEach(f =>
    hojaStore.push(normalizeFile(f, 'hoja'))
  );
  render(hojaStore, hojaList, i => {
    hojaStore.splice(i, 1);
    render(hojaStore, hojaList, arguments.callee);
  });
  hoja.value = '';
};

/* ===================== SUBMIT ===================== */
medicionForm.onsubmit = async e => {
  e.preventDefault();
  submitBtn.disabled = true;

  const fd = new FormData();
  fd.append('list_id', list_id.value);
  fd.append('taskName', taskName.value);
  fd.append('description', description.value);
  fd.append('electrodomesticos', electrodomesticos.value);
  fd.append('observaciones', observaciones.value);

  photosStore.forEach(f => fd.append('photos[]', f));
  hojaStore.forEach(f => fd.append('hoja_medicion[]', f));

  try {
    const r = await fetch(CREATE_MEDICION_URL, { method: 'POST', body: fd });
    if (!r.ok) throw new Error();
    statusMsg.textContent = '‚úÖ Medici√≥n enviada correctamente';
    statusMsg.classList.remove('hidden');
    medicionForm.reset();
    photosStore = [];
    hojaStore = [];
    photosList.innerHTML = '';
    hojaList.innerHTML = '';
  } catch {
    statusMsg.textContent = '‚ùå Error al enviar la medici√≥n';
    statusMsg.classList.remove('hidden');
  } finally {
    submitBtn.disabled = false;
  }
};
</script>
</body>
</html>
